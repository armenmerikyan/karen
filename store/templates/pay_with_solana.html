<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pay with Solana</title>
    
    <script src="https://unpkg.com/@solana/web3.js@latest/lib/index.iife.js"></script>
</head>
<body>
    <h1>Pay with Solana</h1>
    <div>
        <h2>Cart Summary</h2>
        <ul>
            {% for product in products %}
            <li>{{ product.product.name }} - {{ product.quantity }} x ${{ product.price }} = ${{ product.line_item_total }}</li>
            {% endfor %}
        </ul>
        <p>Subtotal: ${{ subtotal }}</p>
        <p>Total Tax: ${{ total_tax }}</p>
        <p>Total with Tax: ${{ total_with_tax }}</p>
    </div>
    <form id="solanaPaymentForm">
        <input type="hidden" id="customerPublicKey" name="customerPublicKey">
        <input type="hidden" id="signedTransaction" name="signedTransaction">
        <button type="submit">Pay with Solana</button>
    </form>

    <script>
        document.getElementById('solanaPaymentForm').addEventListener('submit', async function(event) {
            event.preventDefault();

            // Check if Phantom Wallet is installed
            if (!window.solana || !window.solana.isPhantom) {
                alert("Please install Phantom Wallet");
                return;
            }

            try {
                // Connect Phantom Wallet
                await window.solana.connect();
                const provider = window.solana;
                const customerWallet = provider.publicKey;

                console.log("Connected wallet:", customerWallet.toString());

                const connection = new solanaWeb3.Connection("https://api.mainnet-beta.solana.com");
                const merchantPublicKey = new solanaWeb3.PublicKey("{{ profile.wallet }}");
                const amountInLamports = {{ total_in_lamports }};

                // Create the transaction
                let transaction = new solanaWeb3.Transaction().add(
                    solanaWeb3.SystemProgram.transfer({
                        fromPubkey: customerWallet,
                        toPubkey: merchantPublicKey,
                        lamports: amountInLamports,
                    })
                );

                transaction.feePayer = customerWallet;
                transaction.recentBlockhash = (await connection.getLatestBlockhash()).blockhash;

                // Sign the transaction using Phantom Wallet
                const signedTransaction = await provider.signTransaction(transaction);

                // Serialize the transaction using Uint8Array
                const serializedTransaction = signedTransaction.serialize();
                
                // Convert the serialized transaction into a base64 string
                const base64Transaction = btoa(String.fromCharCode(...new Uint8Array(serializedTransaction)));

                // Set the form values
                document.getElementById('customerPublicKey').value = customerWallet.toString();
                document.getElementById('signedTransaction').value = base64Transaction;

                // Submit the form to the backend (Django)
                const formData = new FormData(document.getElementById('solanaPaymentForm'));
                const response = await fetch("{% url 'pay_with_solana' %}", {
                    method: "POST",
                    body: formData,
                    headers: { 'X-CSRFToken': '{{ csrf_token }}' },
                });

                const result = await response.json();
                if (result.success) {
                    window.location.href = '{% url "success" %}';
                } else {
                    alert('Payment failed: ' + result.error);
                }
            } catch (error) {
                console.error("Error during transaction:", error);
                alert("Transaction failed: " + error.message);
            }
        });
    </script>
</body>
</html>