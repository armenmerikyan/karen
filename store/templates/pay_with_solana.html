<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pay with Solana</title>
    
    <script src="https://cdn.jsdelivr.net/npm/buffer@6.0.3/index.min.js"></script>
    <script>
        // Polyfill Buffer
        window.Buffer = window.buffer.Buffer;
    </script>
    <script src="https://unpkg.com/@solana/web3.js@latest/dist/index.iife.min.js"></script>

</head>
<body>
    <h1>Pay with Solana</h1>
    <div>
        <h2>Cart Summary</h2>
        <ul>
            {% for product in products %}
            <li>{{ product.product.name }} - {{ product.quantity }} x ${{ product.price }} = ${{ product.line_item_total }}</li>
            {% endfor %}
        </ul>
        <p>Subtotal: ${{ subtotal }}</p>
        <p>Total Tax: ${{ total_tax }}</p>
        <p>Total with Tax: ${{ total_with_tax }}</p>
    </div>
    <form id="solanaPaymentForm">
        <input type="hidden" id="customerPublicKey" name="customerPublicKey">
        <input type="hidden" id="signedTransaction" name="signedTransaction">
        <button type="submit">Pay with Solana</button>
    </form>

    <script>
        document.getElementById('solanaPaymentForm').addEventListener('submit', async function(event) {
            event.preventDefault();

            if (!window.solana || !window.solana.isPhantom) {
                alert("Please install Phantom Wallet");
                return;
            }

            try {
                await window.solana.connect();
                const provider = window.solana;
                const customerWallet = provider.publicKey;

                const connection = new solanaWeb3.Connection("https://api.mainnet-beta.solana.com");
                const merchantPublicKey = new solanaWeb3.PublicKey("{{ profile.wallet }}");
                const amountInLamports = {{ total_in_lamports }};

                let transaction = new solanaWeb3.Transaction().add(
                    solanaWeb3.SystemProgram.transfer({
                        fromPubkey: customerWallet,
                        toPubkey: merchantPublicKey,
                        lamports: amountInLamports,
                    })
                );

                transaction.feePayer = customerWallet;
                transaction.recentBlockhash = (await connection.getLatestBlockhash()).blockhash;

                const signedTransaction = await provider.signTransaction(transaction);
                const serializedTransaction = signedTransaction.serialize();

                document.getElementById('customerPublicKey').value = customerWallet.toString();
                document.getElementById('signedTransaction').value = Buffer.from(serializedTransaction).toString('hex');

                const formData = new FormData(document.getElementById('solanaPaymentForm'));
                const response = await fetch('{% url "pay_with_solana" %}', {
                    method: 'POST',
                    body: formData,
                    headers: { 'X-CSRFToken': '{{ csrf_token }}' },
                });

                const result = await response.json();
                if (result.success) {
                    window.location.href = '{% url "success" %}';
                } else {
                    alert('Payment failed: ' + result.error);
                }
            } catch (error) {
                alert("Transaction failed: " + error.message);
            }
        });
    </script>
</body>
</html>
