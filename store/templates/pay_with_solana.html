<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Solana Payment</title>
    <script src="https://cdn.jsdelivr.net/npm/@solana/web3.js@1.64.0/dist/solana-web3.iife.min.js"></script>
</head>
<body>

<button id="connectButton">Connect Phantom Wallet</button>
<div id="walletAddress"></div>
<div id="tokenBalance"></div>

<form id="sendSolForm">
    <input type="text" id="recipientAddress" placeholder="Recipient Address" required>
    <input type="number" id="amount" placeholder="Amount in SOL" required>
    <button type="submit">Send SOL</button>
</form>

<div id="transactionStatus"></div>

<script>
    window.onload = function () {
        console.log(solanaWeb3); // Check if it's defined
        if (typeof solanaWeb3 !== "undefined") {
            console.log("Solana Web3 is ready");
        } else {
            console.error("Solana Web3 is not defined");
        }
    };
    // Function to convert ArrayBuffer to Base64
    function arrayBufferToBase64(buffer) {
        let binary = '';
        const bytes = new Uint8Array(buffer);
        const len = bytes.byteLength;
        for (let i = 0; i < len; i++) {
            binary += String.fromCharCode(bytes[i]);
        }
        return window.btoa(binary);
    }

    document.getElementById('connectButton').addEventListener('click', async () => {
        if (window.solana && window.solana.isPhantom) {
            try {
                // Connect to Phantom wallet
                const response = await window.solana.connect();
                console.log('Connected to Phantom wallet');
                document.getElementById('walletAddress').textContent = `Connected wallet: ${response.publicKey.toString()}`;

                // Fetch and display balance (if needed for further display)
                const tokenBalanceElement = document.getElementById('tokenBalance');
                const tokenMintAddress = '{{MY_TOKEN}}'; // Replace with actual SPL token mint address
                const rpcUrl = 'https://worldchain-mainnet.g.alchemy.com/v2/t7AGL7qRXHF4jvodUVH7gWn3lvSfk_jl'; // Replace with your QuickNode URL
                const connection = new solanaWeb3.Connection(rpcUrl);
                const tokenAccounts = await connection.getParsedTokenAccountsByOwner(response.publicKey, {
                    mint: new solanaWeb3.PublicKey(tokenMintAddress)
                });
                let tokenBalance = 0;
                if (tokenAccounts.value.length > 0) {
                    tokenAccounts.value.forEach(accountInfo => {
                        tokenBalance += accountInfo.account.data.parsed.info.tokenAmount.uiAmount;
                    });
                }
                tokenBalanceElement.textContent = `Token balance: ${tokenBalance}`;

            } catch (error) {
                console.error('Error:', error);
                alert('Error connecting to Phantom wallet');
            }
        } else {
            alert('Phantom wallet not found');
        }
    });

    document.getElementById('sendSolForm').addEventListener('submit', async (e) => {
        e.preventDefault();

        const recipientAddress = document.getElementById('recipientAddress').value;
        const amountInSol = parseFloat(document.getElementById('amount').value);
        const tokenBalanceElement = document.getElementById('tokenBalance');
        const transactionStatusElement = document.getElementById('transactionStatus');

        if (!recipientAddress || isNaN(amountInSol) || amountInSol <= 0) {
            transactionStatusElement.textContent = 'Please enter a valid recipient address and amount.';
            return;
        }

        if (window.solana && window.solana.isPhantom) {
            try {
                const response = await window.solana.connect();

                // Create the transaction
                const transaction = new solanaWeb3.Transaction().add(
                    solanaWeb3.SystemProgram.transfer({
                        fromPubkey: response.publicKey,
                        toPubkey: new solanaWeb3.PublicKey(recipientAddress),
                        lamports: solanaWeb3.LAMPORTS_PER_SOL * amountInSol, // Convert SOL to lamports (1 SOL = 1e9 lamports)
                    })
                );

                // Send the transaction
                const signature = await window.solana.sendTransaction(transaction, window.solana);
                console.log('Transaction sent:', signature);

                // Confirm the transaction
                const confirmation = await window.solana.confirmTransaction(signature);
                if (confirmation.value.err) {
                    console.error('Transaction Error:', confirmation.value.err);
                    throw new Error('Transaction failed');
                } else {
                    console.log('Transaction successful');
                    transactionStatusElement.textContent = `Successfully sent ${amountInSol} SOL!`;
                    tokenBalanceElement.textContent = `Token balance: Updated (if applicable)`;
                }
            } catch (error) {
                console.error('Error sending transaction:', error);
                transactionStatusElement.textContent = 'Transaction failed. Please try again.';
            }
        } else {
            alert('Phantom wallet not found');
        }
    });
</script>

</body>
</html>
