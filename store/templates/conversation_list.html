{% extends "base.html" %}

{% block content %}
<div class="container">
    <h2>Conversations</h2>
    {% for conversation in conversations %}
        <div class="card mb-3">
            <div class="card-header">
                <h3>Conversation ID: {{ conversation.id }}</h3>
                <p>Started by: {{ conversation.user.username }} {{ conversation.user.email }}</p>
                <p>Created at: {{ conversation.created_at }}</p>
                {% if conversation.customer %}
                    <p>Customer: 
                        <a href="{% url 'customer_edit' conversation.customer.id %}">
                            {{ conversation.customer.first_name }} {{ conversation.customer.last_name }}
                        </a>
                    </p>
                    <p>Email: {{ conversation.customer.email }}</p>
                    <p>Phone: {{ conversation.customer.phone_number }}</p>
                {% else %}
                    <p>No associated customer</p>
                    <a href="{% url 'customer_create' %}?email={{ conversation.user.email }}" class="btn btn-secondary">Create Customer</a>
                {% endif %}
                <button class="btn btn-primary toggle-messages" type="button" data-bs-toggle="collapse" data-bs-target="#messages-{{ conversation.id }}" aria-expanded="false" aria-controls="messages-{{ conversation.id }}">
                    <span class="button-text">Show</span>
                    <i class="fas fa-chevron-down"></i>
                </button>
            </div>
            <div class="collapse" id="messages-{{ conversation.id }}">
                <div class="card-body">
                    <ul class="list-group">
                        {% for message in conversation.messages.all %}
                            <li class="list-group-item">
                                <strong>{{ message.role }}:</strong> {{ message.content }} ({{ message.timestamp }})
                            </li>
                        {% endfor %}
                    </ul>
                </div>
            </div>
        </div>
    {% endfor %}
</div>

<!-- Include Font Awesome -->
<script src="https://kit.fontawesome.com/your-fontawesome-kit.js" crossorigin="anonymous"></script>

<!-- Custom JavaScript for toggling button text and icon -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    const toggleButtons = document.querySelectorAll('.toggle-messages');

    toggleButtons.forEach(button => {
        button.addEventListener('click', function() {
            const buttonText = button.querySelector('.button-text');
            const icon = button.querySelector('i');

            if (buttonText.textContent === 'Show') {
                buttonText.textContent = 'Hide';
                icon.classList.remove('fa-chevron-down');
                icon.classList.add('fa-chevron-up');
            } else {
                buttonText.textContent = 'Show';
                icon.classList.remove('fa-chevron-up');
                icon.classList.add('fa-chevron-down');
            }
        });
    });
});
</script>
{% endblock %}