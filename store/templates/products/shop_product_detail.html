{% extends 'base.html' %}
{% load custom_filters %}
{% block content %}
<section class="py-0">
  <div class="container-fluid">
    <div class="container mt-5 text-light">         
      <div class="row">
        <div class="col-md-12 text-left">   
            <h1>{{ product.name }}</h1>
            <p><strong>Description:</strong> {{ product.description }}</p>
            <p><strong>Price:</strong> ${{ product.price }}</p>
            {% if product.product_image %}
                <img src="{{ product.product_image.url }}" alt="{{ product.name }}" width="200">
            {% endif %}

            <HR>

            <!-- Add to Cart Form -->
            <form id="addToCartForm">
                {% csrf_token %} <!-- Add the CSRF token here -->
                <input type="hidden" name="product_id" value="{{ product.id }}">
                <label for="quantity">Quantity:</label>
                <input type="number" id="quantity" name="quantity" value="1" min="1">
                <button type="submit" class="btn btn-primary">Add to Cart</button>
            </form>

            <a href="{% url 'shop_product_list' %}">Back to Product List</a>

            <!-- Bootstrap Alert for messages -->
            <div id="cartMessage" class="alert d-none" role="alert"></div>
        </div>
      </div>      
    </div>
  </div>
</section>    

<!-- Embedded JavaScript -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('addToCartForm');
    const messageBox = document.getElementById('cartMessage');

    form.addEventListener('submit', function(event) {
        event.preventDefault(); // Prevent the default form submission

        const formData = new FormData(form);
        const productId = formData.get('product_id');
        const quantity = formData.get('quantity');
        const csrfToken = formData.get('csrfmiddlewaretoken'); // Get the CSRF token from the form

        fetch('{% url "shop_add_to_cart" %}', {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrfToken, // Include the CSRF token in the headers
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: `product_id=${productId}&quantity=${quantity}&csrfmiddlewaretoken=${csrfToken}`
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                messageBox.className = "alert alert-success"; // Success style
                messageBox.textContent = 'Product added to cart successfully!';
                messageBox.classList.remove('d-none');
            } else {
                messageBox.className = "alert alert-danger"; // Error style
                messageBox.textContent = 'Failed to add product to cart: ' + data.message;
                messageBox.classList.remove('d-none');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            messageBox.className = "alert alert-danger";
            messageBox.textContent = 'An error occurred. Please try again later.';
            messageBox.classList.remove('d-none');
        });
    });
});
</script>
{% endblock %}
