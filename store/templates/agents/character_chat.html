{% extends "base.html" %}
{% load static %}

{% block content %}
<section class="py-0">
  <div class="container mt-5 text-dark">
    <h1>Chat with Bot</h1>

    <div id="character_chat_window" style="border: 1px solid #ccc; padding: 10px; width: 100%; max-width: 600px; height: 400px; overflow-y: scroll; background: #f9f9f9;">
      <!-- Chat messages will appear here -->
    </div>

    <input type="text" id="character_user_message" placeholder="Type your message here..." style="width:80%;">
    <button type="button" onclick="character_send_message()">Send</button>
  </div>
</section>
{% endblock %}

{% block extra_js %}
<script>
  function character_get_cookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      const cookies = document.cookie.split(';');
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.substring(0, name.length + 1) === (name + '=')) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }

  function character_send_message() {
    const inputField = document.getElementById('character_user_message');
    const messageText = inputField.value.trim();
    if (!messageText) return;

    const chatWindow = document.getElementById('character_chat_window');
    const userMsgDiv = document.createElement('div');
    userMsgDiv.classList.add('character_message', 'character_user');
    userMsgDiv.style.color = 'blue';
    userMsgDiv.textContent = "You: " + messageText;
    chatWindow.appendChild(userMsgDiv);
    chatWindow.scrollTop = chatWindow.scrollHeight;
    inputField.value = '';

    fetch("{{ chat_url }}", {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': character_get_cookie('csrftoken')
      },
      body: JSON.stringify({ message: messageText })
    })
    .then(response => response.json())
    .then(data => {
      const botMsgDiv = document.createElement('div');
      botMsgDiv.classList.add('character_message', 'character_bot');
      botMsgDiv.style.color = 'green';
      botMsgDiv.textContent = data.response ? "Bot: " + data.response : "Error: " + (data.error || 'Unknown error');
      chatWindow.appendChild(botMsgDiv);
      chatWindow.scrollTop = chatWindow.scrollHeight;
    })
    .catch(error => {
      console.error('Error:', error);
      const errorDiv = document.createElement('div');
      errorDiv.classList.add('character_message', 'character_bot');
      errorDiv.style.color = 'red';
      errorDiv.textContent = "Error: " + error;
      chatWindow.appendChild(errorDiv);
      chatWindow.scrollTop = chatWindow.scrollHeight;
    });
  }
</script>
{% endblock %}

