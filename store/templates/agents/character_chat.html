{% extends 'base.html' %}
{% load static %}
{% load custom_filters %}

{% block content %}
<section class="py-0">
  <div class="container-fluid">
    <div class="container mt-5 text-light">         
      <div class="row">
        <div class="col-md-12 text-left">   

          <h1>Chat with Bot</h1>
          <div id="chatWindow" style="border: 1px solid #ccc; padding: 10px; width: 500px; height: 400px; overflow-y: scroll; margin-bottom: 10px; background: #f9f9f9;">
            <!-- Chat messages will appear here -->
          </div>
          <input type="text" id="userMessage" placeholder="Type your message here..." style="width:400px;">
          <button type="button" onclick="sendMessage()">Send</button>

          <style>
            .message {
              margin-bottom: 10px;
            }
            .user {
              color: blue;
            }
            .bot {
              color: green;
            }
          </style>

          <script>
            function getCookie(name) {
              let cookieValue = null;
              if (document.cookie && document.cookie !== '') {
                  const cookies = document.cookie.split(';');
                  for (let i = 0; i < cookies.length; i++){
                      const cookie = cookies[i].trim();
                      if (cookie.substring(0, name.length + 1) === (name + '=')) {
                          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                          break;
                      }
                  }
              }
              return cookieValue;
            }

            function sendMessage() {
              const userMessageInput = document.getElementById('userMessage');
              const messageText = userMessageInput.value;
              if (!messageText) {
                return;
              }
              
              const chatWindow = document.getElementById('chatWindow');
              const userMessageDiv = document.createElement('div');
              userMessageDiv.classList.add('message', 'user');
              userMessageDiv.textContent = "You: " + messageText;
              chatWindow.appendChild(userMessageDiv);
              chatWindow.scrollTop = chatWindow.scrollHeight;

              userMessageInput.value = '';

              const data = { message: messageText };

              fetch("{{ chat_url }}", {
                  method: 'POST',
                  headers: {
                      'Content-Type': 'application/json',
                      'X-CSRFToken': getCookie('csrftoken')
                  },
                  body: JSON.stringify(data)
              })
              .then(response => response.json())
              .then(data => {
                  const botMessageDiv = document.createElement('div');
                  botMessageDiv.classList.add('message', 'bot');
                  if(data.response) {
                      botMessageDiv.textContent = "Bot: " + data.response;
                  } else if(data.error) {
                      botMessageDiv.textContent = "Error: " + data.error;
                  }
                  chatWindow.appendChild(botMessageDiv);
                  chatWindow.scrollTop = chatWindow.scrollHeight;
              })
              .catch(error => {
                  console.error('Error:', error);
                  const errorDiv = document.createElement('div');
                  errorDiv.classList.add('message', 'bot');
                  errorDiv.textContent = "Error: " + error;
                  chatWindow.appendChild(errorDiv);
                  chatWindow.scrollTop = chatWindow.scrollHeight;
              });
            }
          </script>

        </div>
      </div>      
    </div>
  </div>
</section>    
{% endblock %}
