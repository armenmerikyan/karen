{% extends 'base.html' %}
{% block content %}
<section class="py-5">
  <div class="container">
    <div class="row justify-content-center">
      <div class="col-lg-8">
        <!-- Terminal Header -->
        <div class="terminal-header text-center mb-4">
          <h2 class="text-monospace mb-1">> User Profile Configuration</h2>
          <p class="text-monospace text-terminal-muted blink">> Customize Your Interface_</p>
        </div>

        <!-- Profile Cards -->
        <div class="row g-4">
          <!-- Basic Info Card -->
          <div class="col-12">
            <div class="card bg-terminal-dark border-terminal-green hover-terminal-item">
              <div class="card-body p-4">
                <div class="d-flex align-items-center mb-3">
                  <span class="text-terminal-green me-2">></span>
                  <h3 class="text-monospace mb-0">Basic Information</h3>
                </div>
                <div class="terminal-content">
                  <form method="POST" class="needs-validation" novalidate>
                    {% csrf_token %}
                    <div class="row g-3">
                      <div class="col-md-6">
                        <label class="text-monospace text-terminal-muted">Username</label>
                        <input type="text" class="form-control bg-black text-terminal-green" value="{{ user.username }}" readonly>
                      </div>
                      <div class="col-md-6">
                        <label class="text-monospace text-terminal-muted">Email</label>
                        <input type="email" class="form-control bg-black text-terminal-green" value="{{ user.email }}" readonly>
                      </div>
                      <div class="col-md-6">
                        <label class="text-monospace text-terminal-muted">First Name</label>
                        {{ form.first_name }}
                      </div>
                      <div class="col-md-6">
                        <label class="text-monospace text-terminal-muted">Last Name</label>
                        {{ form.last_name }}
                      </div>
                      <div class="col-12">
                        <label class="text-monospace text-terminal-muted">OpenAI API Key</label>
                        {{ form.openai_api_key }}
                      </div>
                    </div>
                    <div class="mt-4">
                      <button type="submit" class="btn btn-terminal">
                        > save_changes <span class="blink">_</span>
                      </button>
                    </div>
                  </form>
                </div>
              </div>
            </div>
          </div>

          <!-- Wallet Integration -->
          <div class="col-md-6">
            <div class="card bg-terminal-dark border-terminal-green hover-terminal-item">
              <div class="card-body p-4">
                <div class="d-flex align-items-center mb-3">
                  <span class="text-terminal-green me-2">></span>
                  <h3 class="text-monospace mb-0">Wallet</h3>
                </div>
                <div class="terminal-content">
                  <p class="text-monospace text-terminal-muted mb-3" id="walletAddress">
                    > awaiting_connection...
                  </p>
                  <button id="connectButton" class="btn btn-terminal">
                    > connect_phantom <span class="blink">_</span>
                  </button>
                </div>
              </div>
            </div>
          </div>

          <!-- API Token -->
          <div class="col-md-6">
            <div class="card bg-terminal-dark border-terminal-green hover-terminal-item">
              <div class="card-body p-4">
                <div class="d-flex align-items-center mb-3">
                  <span class="text-terminal-green me-2">></span>
                  <h3 class="text-monospace mb-0">API Access</h3>
                </div>
                <div class="terminal-content">
                  <p class="text-monospace text-terminal-muted mb-3" id="tokenDisplay">
                    > token_status: active
                  </p>
                  <button id="generateTokenButton" class="btn btn-terminal">
                    > generate_token <span class="blink">_</span>
                  </button>
                </div>
              </div>
            </div>
          </div>

          <!-- Token Balance -->
          <div class="col-12">
            <div class="card bg-terminal-dark border-terminal-green hover-terminal-item">
              <div class="card-body p-4">
                <div class="d-flex align-items-center mb-3">
                  <span class="text-terminal-green me-2">></span>
                  <h3 class="text-monospace mb-0">Token Balance</h3>
                </div>
                <div class="terminal-content">
                  <p class="text-monospace text-terminal-green mb-0" id="tokenBalance">
                    > checking_balance...
                  </p>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Logout -->
        <div class="text-center mt-4">
          <a href="{% url 'logout' %}" class="btn btn-terminal-red">
            > terminate_session <span class="blink">_</span>
          </a>
        </div>
      </div>
    </div>
  </div>
</section>

<script>
  document.getElementById('generateTokenButton').addEventListener('click', function () {
    fetch('/generate-token/', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': '{{ csrf_token }}'
      },
      credentials: 'include'
    })
    .then(response => response.json())
    .then(data => {
      document.getElementById('tokenDisplay').textContent = data.token || 'Error generating token';
    })
    .catch(error => {
      console.error('Error:', error);
      document.getElementById('tokenDisplay').textContent = 'Error generating token';
    });
  });
</script>

<script>
  function arrayBufferToBase64(buffer) {
    let binary = '';
    const bytes = new Uint8Array(buffer);
    bytes.forEach(byte => binary += String.fromCharCode(byte));
    return window.btoa(binary);
  }

  document.getElementById('connectButton').addEventListener('click', async () => {
    if (window.solana && window.solana.isPhantom) {
      try {
        const response = await window.solana.connect();
        document.getElementById('walletAddress').textContent = `Connected wallet: ${response.publicKey.toString()}`;

        const message = new TextEncoder().encode('Hello from Game!');
        const signedMessage = await window.solana.signMessage(message);
        const signatureBase64 = arrayBufferToBase64(signedMessage.signature);

        const verifySignatureUrl = `/verify_signature_game/?publicKey=${response.publicKey.toString()}&signature=${encodeURIComponent(signatureBase64)}`;

        const verifySignature = async () => {
          try {
            const res = await fetch(verifySignatureUrl);
            const result = await res.json();
            if (result.valid) {
              document.getElementById('tokenBalance').style.color = 'green';
              document.getElementById('connectButton').style.display = 'none';
            } else {
              document.getElementById('tokenBalance').style.color = '#00FF00';
            }
          } catch (error) {
            console.error('Verification Error:', error.message);
          }
        };

        await verifySignature();

        const tokenMintAddress = '{{MY_TOKEN}}';
        const rpcUrl = 'https://worldchain-mainnet.g.alchemy.com/v2/t7AGL7qRXHF4jvodUVH7gWn3lvSfk_jl';
        const connection = new solanaWeb3.Connection(rpcUrl);
        const tokenAccounts = await connection.getParsedTokenAccountsByOwner(response.publicKey, {
          mint: new solanaWeb3.PublicKey(tokenMintAddress)
        });

        let tokenBalance = 0;
        tokenAccounts.value.forEach(accountInfo => {
          tokenBalance += accountInfo.account.data.parsed.info.tokenAmount.uiAmount;
        });

        document.getElementById('tokenBalance').textContent = `Token balance: ${tokenBalance}`;

      } catch (error) {
        console.error('Phantom connection error:', error);
        alert('Connection failed. See console for details.');
      }
    } else {
      alert('Phantom wallet not found');
    }
  });
</script>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    const openaiApiKey = "{{ user.openai_api_key|default:'' }}";
    if (openaiApiKey) {
      fetch('/api/register_mcp/', {
        method: 'GET',
        credentials: 'include'
      })
      .then(res => res.json())
      .then(data => {
        console.log('MCP Registration:', data);
      })
      .catch(error => {
        console.error('MCP registration failed:', error);
      });
    }
  });
</script>
{% endblock %}
